---
title: kube-dns
tags:
  - k8s-核心组件
categories:
  - Kubernetes
comments: true
date: 2022-07-19 17:15:57
---


### DNS

DNS是Kubernetes的核心功能之一，通过kube-dns或CoreDNS作为集群的必备扩展来提供命名服务。

### CoreDNS

从v1.11开始可以使用CoreDNS来提供命名服务，并从v1.13开始称为默认DNS服务。CoreDNS的特点是效率更高，资源占用率更小，推荐使用CoreDNS替代kube-dns为集群提供DNS服务。

### 支持的DNS格式

* Service
    * A record：生成`my-svc.my-namespace.svc.cluster.local`，解析IP分为两种情况
        * 普通Service解析为Cluster IP
        * Headless Service 解析为指定的Pod IP列表
    * SRV record：生成`_my-port-name._my-port-protocol.my-svc.my-namespace.svc.cluster.local`
* Pod
    * A record：`pod-ip-address.my-namespace.pod.cluster.local`
    * 指定hostname和subdomain：`hostname.custom-subdomain.default.svc.cluster.local`，如下所示

```
apiVersion: v1
kind: Pod
metadata:
  name: busybox2
  labels:
    name: busybox
spec:
  hostname: busybox-2
  subdomain: default-subdomain
  containers:
  - image: busybox
    command:
      - sleep
      - "3600"
    name: busybox
```

### 支持配置私有DNS服务器和上游DNS服务器

从V1.6开始，可以通过为kube-dns提供ConfigMap来实现对存根域以及上游名称服务器的自定义指定。例如：

```
插入了一个单独的私有根 DNS 服务器和两个上游 DNS 服务器
apiVersion: v1
kind: ConfigMap
metadata:
  name: kube-dns
  namespace: kube-system
data:
  stubDomains: |
    {“acme.local”: [“1.2.3.4”]}
  upstreamNameservers: |
    [“8.8.8.8”, “8.8.4.4”]
```

使用上述特定配置，查询请求首先会被发送到kube-dns的DNS缓存层（Dnsmasq）。Dnsmasq服务器会先检查请求的后缀，带有集群后缀（例如：.cluster.local）的请求会被发往kube-dns，拥有存根域后缀的名称（例如：.acme.local）将会被发送到配置的私有DNS服务器[1.2.3.4].最后，不满足任何这些后缀的请求将会被发送到上游DNS [8.8.8.8, 8.8.4.4]。

### kube-dns工作原理

kube-dns由三个容器构成：

* kube-dns：DNS服务的核心组件，主要由KubeDNS和SkyDNS组成
    * KubeDNS负责监听Service和EndPoint的变化情况，并将相关的信息更新到SkyDNS中
    * SkyDNS负责DNS解析，监听在10053端口（tcp/udp）,同时也监听在10055端口提供metrics
    * kube-dns还监听了8081端口，以供健康检查使用
* dnsmasq-nanny：负责启动dnsmasq，并在配置发生变化时重启dnsmasq
    * dnsmasq的upstram为SkyDNS，即集群内部的DNS解析由SkyDNS负责
* sidecar：负责健康检查和DNS metrics（监听在10054端口）


