---
title: MySQL-事务与隔离级别
tags:
  - MySQL事务
categories:
  - MySQL
comments: true
date: 2022-07-05 09:40:03
---


### 事务

事务（Transaction）是访问和更新数据库的程序执行单元；事务中包含一个或多个sql语句，这些语句要么都执行，要么都不执行。

### ACID

#### 原子性

是指一个事务时一个不可分割的工作单位，其中的操作要么都做，要么都不做

在说明原理之前，首先介绍一下MySQL的事务日志，如二进制日志、错误日志、查询日志、慢查询日志等，此外InnoDB存储引擎还提供了两种事务日志：redo log（重做日志）和undo log（回滚日志）。其中redo log 用于保证事务持久性；undo log则是事务原子性和隔离性的实现基础。

InnoDB实现回滚，靠的是undo log：当事务对数据库进行修改时，InnoDB会生成对应的undo log；如果事务执行失败或调用了rollback，导致事务需要回滚，便可以利用undo log中的信息将数据回滚到修改之前的样子

#### 持久性

是指一旦事务提交，他对数据库的改变就应该是永久性的。
InnoDB作为MySQL的存储引擎，数据是存放在磁盘中的，但如果每次读写数据都需要磁盘IO，效率很低。为此，InnoDB提供了缓存（Buffer pool），Buffer Pool中包含了磁盘中部分数据页的映射，作为访问数据库的缓冲：当从数据库读取数据时，会首先从Buffer Pool中读取，如果Buffer Pool中没有，则从磁盘读取后放入Buffer Pool；当向数据库写入数据时，会首先写入Buffer Pool，BufferPool中修改的数据会定期刷新到磁盘中。

buffer Pool的使用大大提高了读写数据的效率，但也带来了新的问题，如果mysql宕机，而此时Buffer Pool中修改的数据还没有刷新到磁盘，就会导致数据的丢失，事务的持久性无法保证。

于是，redo log被引来解决这个问题：当数据修改时，除了修改Buffer Pool中的数据，还会在redo log记录这次数据；当事务提交时，会调用fsync接口对redo log 进行刷盘。如果mySQL宕机，重启时可以读取redo log中的数据，对数据库进行恢复。redo log 采用的时WAL（write-ahead loggong，预写式日志），所有修改先写入日志，再更新到buffer pool，达到了持久性要求。

#### 隔离性

是指事物内部的操作与其他事务是隔离的，并发执行的各个事务之间不能互相干扰。
隔离性的探讨，主要分为两个方面：
（1）写操作对写操作的影响：锁机制保证隔离性
（2）写操作对读操作的影响：MVCC保证隔离性

#### 一致性

是指事务执行结束后，数据库的完整性约束没有被破坏，事务执行的前后都是合法的数据状态。

实现一致性的措施包括：
（1）保证原子性、持久性和隔离性，如果这些特性无法保证，事务的一致性也无法保证。
（2）数据库本身提供保障，例如不允许向整形列插入字符串值、字符串长度不能超过列的限制等
（3）应用层面进行保障，录入转账操作之扣除转账者的月，而没有增加接收者的余额，无法保证状态一致。


### 隔离级别

|  隔离级别   | 脏读  |  不可重复读   | 幻读  |
|  ----  | ----  |  ----  | ----  |
| 读未提交  | 可能 | 可能  | 可能 |
| 读已提交  | 不可能 | 可能  | 可能 |
| 可重复读  | 不可能 | 不可能  | 可能 |
| 可串行化  | 不可能 | 不可能  | 不可能 |

```
（1）脏读
当前事务（A）中可以读到其他事务（B）未提交的数据。
（2）不可重复读
在事务A中先后两次读取同一个数据，两次读取的结果不一样。
（3）幻读
在事务A中按照某个条件先后两次查询数据库，两次查询结果的条数不同。
```

