---
title: Controller Manager
tags:
  - k8s-核心组件
categories:
  - Kubernetes
comments: true
date: 2022-07-19 17:15:32
---


### Controller Manager

Controller Manager 由 kube-controller-manager和cloud-controller-manager组成，是Kubernetes的大脑，它通过apiserver监控整个集群的状态，并确保集群处于预期的工作状态。

kube-controller-manager由一系列的控制器组成

* Replication Controller
* Node Controller
* CronJob Controller
* Daemon Controller
* Deployment Controller
* Endpoint Controller
* Garbage Collector
* Namespace Controller
* Job Controller
* Pod AutoScaler
* RelicaSet
* Service Controller
* ServiceAccount Controller
* StatefulSet Controller
* Volume Controller
* Resource quota Controller

cloud-controller-manager 在Kubernete启用Cloud Provider的时候才需要，用来配合云服务提供商的控制，也包括一系列的控制器，如

* Node Controller
* Route Controller
* Service Controller


### 高可用

在启动时设置 `--leader-elect=true`后，controller manager会使用多节点选主的方式选择主节点。只有主节点才会调用`StartControllers()`启动所有控制器，而其他从节点则仅执行选主算法。

多节点选主的实现方法见`leaderelection.go`。

### 高性能

从1.7开始，所有需要监控资源变化情况的调用均推荐使用`Infomer`。Infomer提供了基于事件通知的只读缓存机制，可以注册资源变化的回调函数，并可以极大减少API的调用。

### Node Eviction

Node控制器在节点异常后，会按照默认的效率（`--node-eviction-rate=0.1,即每10秒一个节点的速率`）进行Node的驱逐。Node控制器按照Zone将节点划分为不同的组，再跟进Zone的状态进行速率调整：

* Normal：所有节点都Ready，默认速率驱逐。
* PartialDisruption：即超过33%的节点NotReady的状态。当异常节点比例大于`unhealthy-zone-threshold=0.5`时开始减慢速率。
    * 小集群（即节点数量小于 --large-cluster-size-threshold=50）：停止驱逐
    * 大集群，减慢速率为 --secondary-node-eviction-rate=0.01
* FullDisruption：所有节点都 NotReady，返回使用默认速率驱逐。但当所有 Zone 都处在 FullDisruption 时，停止驱逐。