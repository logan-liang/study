---
title: kube-dns
tags:
  - k8s-资源对象
categories:
  - Kubernetes
comments: true
date: 2022-07-19 17:16:01
---


### Horizontal Pod Autoscaling(HPA)

HPA可以根据CPU使用率或应用自定义metrics自动扩展Pod数量。

* 控制管理器每隔30s查询metrics的资源使用情况
* 支持三种metrics类型
    * 预定义metrics以利用率的方式计算
    * 自定义的Pod metrics，以原始值的方式计算
    * 自定义的object metrics
* 支持两种metrics查询方式：Heapster和自定义的REST API
* 支持多 metrics

### 自定义metrics

使用方法

* 控制管理器开启 `horizontal-pod-autoscaler-use-reset-clients` 
* 控制观其配置的 `--master`或者 `--kubeconfig`
* 在API Server Aggregator中注册自定义的metrics API
 
比如 HorizontalPodAutoscaler 保证每个 Pod 占用 50% CPU、1000pps 以及 10000 请求 / s：

```
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: php-apache
  namespace: default
spec:
  scaleTargetRef:
    apiVersion: apps/v1beta1
    kind: Deployment
    name: php-apache
  minReplicas: 1
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      targetAverageUtilization: 50
  - type: Pods
    pods:
      metricName: packets-per-second
      targetAverageValue: 1k
  - type: Object
    object:
      metricName: requests-per-second
      target:
        apiVersion: extensions/v1beta1
        kind: Ingress
        name: main-route
      targetValue: 10k
status:
  observedGeneration: 1
  lastScaleTime: <some-time>
  currentReplicas: 1
  desiredReplicas: 1
  currentMetrics:
  - type: Resource
    resource:
      name: cpu
      currentAverageUtilization: 0
      currentAverageValue: 0
```

### 状态条件

可以在客户端中看到Kubernete为HorizontalPodAutoscaler 设置的状态条件`status.conditions`，用来判断HorizontalPodAutoscaler 是否可以扩展、是否开启扩展意识是否收到限制。