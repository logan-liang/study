---
title: MySQL-插入原理
tags:
  - MySQL插入
categories:
  - MySQL
comments: true
date: 2022-07-05 13:50:55
---


### innodb写入流程

1、在数据要被写入或者修改时，一定要查找到该数据所位于的page（数据操控的最小单位），如果page没有位于buffer pool，会发生缺页中断，加载磁盘上的page到buffer pool中。
2、查找到page以后，先要保存当前数据到undo log日志（为了事务回滚后，数据也能回滚）。
3、直接修改page 上的数据，buffer pool中的脏页达到一定比例时，会进行刷盘操作。
4、记录redo log 日志，用于事务的持久化。
5、如果开启binlog，也会触发一个redo log 和binlog的二阶段提交。

### redo log

用于保证innodb事务的持久性，在宕机的情况下，根据日志文件进行数据重做，将数据恢复到宕机或者断电前的状态，保证了更新的数据不丢失。它的本质是保证事务提交后，更新的数据不丢失。

### undo log

undolog会保留每行数据一段时间内所有事务的操作记录，用于进行事务回滚以及帮助mvcc进行事务隔离。
mysql会定时获取当前所有readview中最老的事务id，并使用purge线程将该事务之前的undolog 进行回收。

### redo、bin log 双写一致性

innodb采用了二阶段提交，来保障redo和bin log 的一致性。

1、先写入redolog日志，生成事务标记xid，并设置状态为prepare状态。
2、写入binlog日志
3、进行事务提交，更改xid的redolog变成commit状态。