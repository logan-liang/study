---
title: MySQL-Query Cache
tags:
  - MySQL缓存
categories:
  - MySQL
comments: true
date: 2022-07-05 15:42:42
---


### MySQL查询缓存介绍

是MySQL中比较独特的一个缓存区域，用来缓存特定Query的整个结果集信息，且共享给所有客户端。为了提高完全相同的Query语句的响应速度，MySQL会对查询语句进行Hash计算后，把得到的hash值与Query查询的结果集对应存放在Query Cache中。当打开Query Cache之后，MySQL会对接收到的每一个SELECT语句通过特定的HASH计算该Query的HASH值，然后通过该HASH值到Query Cache中去匹配。

* 如果没有匹配，将这个hash值存放在一个hash链表中，并将Query的结果集存放到cache中，存放hash值链表的每个hash节点存放了相应Query结果集在Cache中的覅之，以及该query所涉及到一些table的相关信息。
* 如果通过hash值匹配到了一样的Query，则直接将cache中相应的query结果集返回给客户端。

### MySQL缓存机制

如果运行相同的SQL，服务器直接从缓存中取到结果，不需要在去解析和执行SQL。
如果表更改了，那么使用这个表的所有缓存查询将不再有效，查询缓存中值相关条目被清空。更改指的是表中任何数据或是结构发生改变。
显然，这对于频繁更新的表，查询缓存时不适合的，而对于一些不常改变数据且大量相同SQL查询的表，查询缓存会节约很大的性能。

#### 缓存规则

* 太大的result set不会被cache
* MySQL缓存在分库分表环境下是不起作用
* 执行SQL里有触发器，自定义函数时，MySQL缓存也是不起作用的

#### 缓存失效

* 在表的结构或数据发生改变时，查询缓存中的数据不再有效，如 insert、update、delete等。所以查询缓存适合大量相同查询的应用，不适合大量数据更新的应用。
* 一旦表数据进行任何一行的修改，基于该表相关cache立即全部失效。

#### 手动清理缓存

* FLUSH QUERY CACHE：清理查询缓存内部碎片
* RESET QUERY CACHE：从查询缓存中移除所有查询
* FLUSH TABLES：关闭所有打开的表，同时该操作会清空查询缓存中的内容

### 缺点

* 查询语句的hash计算和hash查找带来的资源消耗。如果将type设置为on，那么mysql会对每条接收到的select类型的查询进行hash计算，然后查找这个查询缓存结果是否存在。如果成千上万条查询语句时，hash计算和查找所带来的开销就会很大。
* query cache的失效问题。如果表的变更比较频繁，则会造成Query Cache的失效率非常高。如果缓存大，消耗也大。可将死一段时间，因为这个操作是靠全局锁来保护。
* 查询语句不同，但查询结果相同的查询都会被缓存，这样便会造成内存资源的过度消耗。查询语句的字符大小写、空格或者注释的不同，Query Cache都会认为是不同的查询。
* 相关系统变量设置不合理会造成大量的内存碎片，这样便会导致Query Cache频繁清理内存。


### MySQL8.0 取消缓存的原因

* 查询缓存的效果取决于缓存的命中率，只有命中缓存的查询效果才能有改善，因此无法预测其性能。
* 查询缓存的另一个大问题是它受到单个互斥锁的保护。在具有多个内核的服务器上，大量查询会导致大量的互斥锁争用。
