---
title: kube-proxy
tags:
  - k8s-核心组件
categories:
  - Kubernetes
comments: true
date: 2022-07-19 17:15:48
---


### kube-proxy

每台机器上都运行一个kube-proxy服务，它监听API Server中service和endpoint的变化情况，并通过iptables等来为服务配置负载均衡。

kube-proxy可以直接运行在物理机上，也可以以static pod 或daemonset的方式运行。

#### kube-proxy当前支持以下几种实现
* userspace：最早的负载均衡方案，它在用户空间监听一个端口，所有服务通过iptables转发到这个端口，然后再其内部负载均衡到实际的Pod。该方式最主要的问题是效率低，有明显的性能瓶颈。
* iptables：目前推荐的方案，完全以iptables规则的方式来实现service负载均衡。该方式最主要的问题是在服务多的时候产生太多的iptables规则，非增量式更新会引入一定的延时，大规模情况下有明显的性能问题
* ipvs：为解决iptables模式的性能问题，v1.11新增了ipvs模式，采用增量式更新，并可以保证service更新期间连接保持不断开

### kube-proxy工作原理

kube-proxy监听API Server中server和endpoint的变化情况，并通过userspace、iptables、ipvs或winuserspace等proxier来为服务配置负载均衡。

### kube-proxy不足

kube-proxy目前仅支持TCP和UDP，不支持HTTP路由，并且也没有健康检查机制。这些可以通过自定义Ingress Controller的方法来解决。

