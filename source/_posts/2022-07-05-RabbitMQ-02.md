---
title: RabbitMQ-延时队列
tags:
  - RabbitMQ-延时队列
categories:
  - RabbitMQ
comments: true
date: 2022-07-05 18:01:50
---


### 延时队列介绍

#### 场景

* 订单下单之后一定时间未支付会自动取消订单
* 涉及到T+d（工作日延迟）或者D+d（自然日延迟）等延迟场景
* 新用户注册之后一个月没下单，发个短信勾引一波

#### 实现

RabbitMQ本身不支持延时队列，它是基于存活时间（TTL）和死信交换机（DLE）实现：
* `TTL`：可以对队列和消息各自设置存活时间，规则是两者中较小的值，即队列无消费者连接的消息过期时间，或者消息在队列中一直未被消费的过期时间。
* `DLE`：过期的消息通过绑定的死信交换机，路由到指定的死信队列，消费者实际上消费的是死信队列上的消息


### 延迟组件

#### 安装

* 下载：请到官网去寻找下载地址
* 启用：rabbitmq-plugins enable rabbitmq_delayed_message_exchange

#### 使用

* 交换机创建时，Arguments设置为：`x-delayed-type`:`direct`
* 绑定指定queue
* 程序层 设置header `x-deplay`:`过期时间`


#### 注意事项

* 延时时间的值必须为非负整数。单位为毫秒。
* 延时时间的最大值为86,400,000，即1天。若延时时间超过最大值，则当作普通消息处理。






